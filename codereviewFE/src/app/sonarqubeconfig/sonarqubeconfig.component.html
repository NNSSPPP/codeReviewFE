<div class="config-container container my-3"> 
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-gear"></i> SonarQube Configuration</h5>
    </div>

    <form #sonarForm="ngForm" novalidate>
      <div class="card-body">
        <!-- Server Configuration -->
        <div class="mb-4">
          <h6 class="fw-semibold">Server Configuration</h6>
          <div class="row g-3">
            <!-- URL -->
            <div class="col-12">
              <label class="form-label" for="sonarserverUrl">SonarQube Server URL *</label>
              <input 
                type="url" 
                id="sonarserverUrl"
                name="serverUrl"
                class="form-control"
                [(ngModel)]="serverUrl"
                required
                pattern="https?://.+"
                placeholder="https://code.pccth.com"
                #serverUrlRef="ngModel"
              />
              <div class="text-danger small" *ngIf="serverUrlRef.invalid && serverUrlRef.touched">
                <div *ngIf="serverUrlRef.errors?.['required']">Server URL is required.</div>
                <div *ngIf="serverUrlRef.errors?.['pattern']">Please enter a valid URL.</div>
              </div>
            </div>

            <!-- Token -->
            <div class="col-12 col-md-8">
              <label class="form-label" for="sonarauthToken">Authentication Token *</label>
              <input 
                [type]="showToken ? 'text' : 'password'" 
                id="sonarauthToken"
                name="authToken"
                class="form-control" 
                [(ngModel)]="authToken" 
                required minlength="10"
                #authTokenRef="ngModel"
              />
              <div class="text-danger small" *ngIf="authTokenRef.invalid && authTokenRef.touched">
                <div *ngIf="authTokenRef.errors?.['required']">Authentication Token is required.</div>
                <div *ngIf="authTokenRef.errors?.['minlength']">Token must be at least 10 characters.</div>
              </div>
            </div>
            <div class="col-12 col-md-4 d-flex align-items-end gap-2">
              <button type="button" class="btn btn-outline-secondary w-100" (click)="toggleShowToken()">
                <i class="bi" [ngClass]="showToken ? 'bi-eye-slash' : 'bi-eye'"></i>
                &nbsp;{{ showToken ? 'Hide' : 'Show' }}
              </button>
            </div>

            <!-- Organization -->
            <div class="col-12">
              <label class="form-label" for="sonarorganization">Default Organization</label>
              <input 
                type="text" 
                id="sonarorganization"
                name="organization"
                class="form-control" 
                [(ngModel)]="organization" 
                maxlength="50"
                placeholder="PCCTH"
              />
            </div>
          </div>
        </div>

        <hr/>

        <!-- Scanner Settings -->
        <div class="mb-4">
          <h6 class="fw-semibold">Scanner Settings</h6>
          <div class="row">
            <!-- Angular Projects -->
            <div class="col-12 col-lg-6 mb-3">
              <div class="card border-light">
                <div class="card-body">
                  <h6 class="card-title">Angular Projects</h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="runNpm" name="runNpm" [(ngModel)]="angularSettings.runNpm">
                    <label class="form-check-label" for="runNpm">Run npm install before scan</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="coverage" name="coverage" [(ngModel)]="angularSettings.coverage">
                    <label class="form-check-label" for="coverage">Generate coverage report</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tsFiles" name="tsFiles" [(ngModel)]="angularSettings.tsFiles">
                    <label class="form-check-label" for="tsFiles">Include TypeScript files</label>
                  </div>
                  <div class="mt-3">
                    <label class="form-label small" for="exclusions">Exclusions</label>
                    <input 
                      class="form-control form-control-sm" 
                      id="exclusions"
                      name="exclusions"
                      [(ngModel)]="angularSettings.exclusions" 
                      placeholder="**/node_modules/**, **/*.spec.ts"
                    />
                    <div class="form-text">Comma separated patterns</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Spring Boot Projects -->
            <div class="col-12 col-lg-6 mb-3">
              <div class="card border-light">
                <div class="card-body">
                  <h6 class="card-title">Spring Boot Projects</h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="runTests" name="runTests" [(ngModel)]="springSettings.runTests">
                    <label class="form-check-label" for="runTests">Run tests before scan</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="jacoco" name="jacoco" [(ngModel)]="springSettings.jacoco">
                    <label class="form-check-label" for="jacoco">Include JaCoCo coverage</label>
                  </div>

                  <div class="mt-3">
                    <label class="form-label small">Build Tool</label>
                    <div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" id="maven" name="buildTool" value="maven" [(ngModel)]="springSettings.buildTool" required>
                        <label class="form-check-label" for="maven">Maven</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" id="gradle" name="buildTool" value="gradle" [(ngModel)]="springSettings.buildTool">
                        <label class="form-check-label" for="gradle">Gradle</label>
                      </div>
                    </div>
                  </div>

                  <div class="mt-2">
                    <label class="form-label small" for="jdkVersion">JDK Version</label>
                    <select 
                      id="jdkVersion"
                      name="jdkVersion"
                      class="form-select form-select-sm" 
                      [(ngModel)]="springSettings.jdkVersion"
                      required
                      #jdkRef="ngModel"
                    >
                      <option *ngFor="let v of jdkVersions" [value]="v">{{ v }}</option>
                    </select>
                    <div class="text-danger small" *ngIf="jdkRef.invalid && jdkRef.touched">Please select JDK version.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr/>

        <!-- Quality Gates -->
        <div class="mb-3">
          <h6 class="fw-semibold">Quality Gates</h6>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="failOnError" name="failOnError" [(ngModel)]="qualityGates.failOnError">
            <label class="form-check-label" for="failOnError">Fail scan if quality gate fails</label>
          </div>    

          <div class="row g-2">
            <div class="col-6 col-md-3">
              <label class="form-label small" for="coverageThreshold">Coverage threshold (%)</label>
              <input type="number" id="coverageThreshold" name="coverageThreshold" class="form-control form-control-sm" [(ngModel)]="qualityGates.coverageThreshold" min="0" max="100"/>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small" for="maxBugs">Max bugs</label>
              <input type="number" id="maxBugs" name="maxBugs" class="form-control form-control-sm" [(ngModel)]="qualityGates.maxBugs" min="0"/>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small" for="maxVulnerabilities">Max vulnerabilities</label>
              <input type="number" id="maxVulnerabilities" name="maxVulnerabilities" class="form-control form-control-sm" [(ngModel)]="qualityGates.maxVulnerabilities" min="0"/>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small" for="maxCodeSmells">Max code smells</label>
              <input type="number" id="maxCodeSmells" name="maxCodeSmells" class="form-control form-control-sm" [(ngModel)]="qualityGates.maxCodeSmells" min="0"/>
            </div>
          </div>
        </div>
      </div>

      <div class="card-footer d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-outline-primary" (click)="testConnection()">
          <i class="bi bi-wifi"></i> Test Connection
        </button>
        <button type="button" class="btn btn-outline-warning" (click)="resetSettings()">Reset</button>
        <button type="submit" class="btn btn-success" [disabled]="sonarForm.invalid" (click)="saveSettings()">
          <i class="bi bi-save"></i> Save Settings
        </button>
      </div>
    </form>
  </div>
</div>
